name: Build OpenWrt Binaries

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: read

jobs:
  openwrt-musl-cgo:
    name: OpenWrt musl + CGO
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/arm64
            goarch: arm64
            filename: arm64
          - platform: linux/arm/v7
            goarch: arm
            goarm: "7"
            filename: arm32

    steps:
      - name: Checkout code (need tags for git describe)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enable QEMU for multi-arch containers
        uses: docker/setup-qemu-action@v3

      - name: Get tag or commit
        id: ref_id
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "ref=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          else
            echo "ref=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
          fi

      - name: Build musl CGO OpenWrt binary (${{ matrix.platform }})
        shell: bash
        env:
          PLATFORM: ${{ matrix.platform }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
          FILENAME: ${{ matrix.filename }}
          VERSION: ${{ steps.ref_id.outputs.ref }}
        run: |
          set -euo pipefail
          mkdir -p dist

          EXTRA_ENV=()
          if [[ -n "${GOARM:-}" ]]; then
            EXTRA_ENV+=(-e GOARM="$GOARM")
          fi

          docker run --rm --platform="$PLATFORM" \
            -v "$PWD:/src" -w /src \
            -e CGO_ENABLED=1 \
            -e GOOS=linux \
            -e GOARCH="$GOARCH" \
            -e VERSION="$VERSION" \
            "${EXTRA_ENV[@]}" \
            golang:1.25-alpine sh -euxc '
              apk add --no-cache git build-base libpcap-dev musl-dev

              # avoid "dubious ownership" when running git inside container
              git config --global --add safe.directory /src

              GIT_COMMIT=$(git rev-parse HEAD || echo unknown)
              GIT_TAG=$(git describe --tags --exact-match 2>/dev/null || echo unknown)
              BUILD_TIME=$(date -u "+%Y-%m-%d %H:%M:%S UTC")

              OUT="paqet_openwrt_musl_'$FILENAME'"

              go build -v -trimpath \
                -ldflags "-s -w \
                  -X '\''paqet/cmd/version.Version=${VERSION}'\'' \
                  -X '\''paqet/cmd/version.GitCommit=${GIT_COMMIT}'\'' \
                  -X '\''paqet/cmd/version.GitTag=${GIT_TAG}'\'' \
                  -X '\''paqet/cmd/version.BuildTime=${BUILD_TIME}'\''" \
                -o "$OUT" ./cmd/main.go

              chmod +x "$OUT"

              tar -czf "dist/paqet-openwrt-musl-'$FILENAME'-${VERSION}.tar.gz" \
                "$OUT" \
                README.md \
                example/client.yaml.example \
                example/server.yaml.example
            '

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: paqet-openwrt-musl-${{ matrix.filename }}
          path: dist/*.tar.gz
